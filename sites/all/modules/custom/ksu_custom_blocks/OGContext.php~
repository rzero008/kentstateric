<?php

namespace ksu_custom_blocks;

class OGContext{
    public static $name = null;
    public static $nid = null;
    public static $type = null;
    public static $campus = null;
    public static $contact = array();
    public static $primaryMenuName = null;
    public static $primaryMenu = array();
    public static $parent = null;
    
    public static function init()
    {
        //dont blow up completely when og context doesnt exist from a fresh install
        if(!function_exists('og_context')){
            return false;
        }
        
        $og = og_context();
        
        if(!empty($og)){
            $og_node = node_load($og['gid']);
            
            self::$name = $og_node->title;
            self::$nid = $og_node->nid;
            self::$type = $og_node->type;
            self::$campus = '';
            self::$contact = array(
                'address' => '',
                'phone' => '',
                'email' => '',
            );
            
            $og_campus_location = field_get_items('node', $og_node, 'field_campus_location');
            self::$campus = taxonomy_term_load($og_campus_location[0]['tid']);
            $og_address = field_get_items('node', $og_node, 'field_group_address');
            $og_phone = field_get_items('node', $og_node, 'field_group_phone');
            $og_email = field_get_items('node', $og_node, 'field_group_email');
            self::$contact['address'] = !empty($og_address) ? $og_address[0]['value'] : '';
            self::$contact['phone'] = !empty($og_phone) ? $og_phone[0]['value'] : '';
            self::$contact['email'] = !empty($og_email) ? $og_email[0]['value'] : '';
            
            $menu_entries = _og_menu_utilities_og_menu_get_group_menus(array('node'=>array(self::$nid)), NULL, 'primary');
            
            if(!empty($menu_entries)){
                self::$primaryMenuName = $menu_entries[0]['menu_name'];
                self::$primaryMenu = menu_tree_output(menu_tree_all_data($menu_entries[0]['menu_name']));
            }
            
            //init parent if it exists
            $og_group_ref = field_get_items('node', $og_node, 'og_group_ref');
            if(!empty($og_group_ref)){
                self::$parent = new OGParentContext($og_group_ref[0]['target_id']);
            }
            return true;
        }
        self::$primaryMenuName = 'menu-kent-campus-main-menu';
        self::$primaryMenu = menu_tree_output(menu_tree_all_data('menu-kent-campus-main-menu'));
        return false;
    }    
}

class OGParentContext{
    public $name = null;
    public $nid = null;
    public $type = null;
    public $contact = null;
    
    public function __construct($og_group_ref){
        $og_node = node_load($og_group_ref);
        $this->name = $og_node->title;
        $this->nid = $og_node->nid;
        $this->type = $og_node->type;

        $og_address = field_get_items('node', $og_node, 'field_group_address');
        $og_phone = field_get_items('node', $og_node, 'field_group_phone');
        $og_email = field_get_items('node', $og_node, 'field_group_email');
        
        $this->contact['address'] = !empty($og_address) ? $og_address[0]['value'] : '';
        $this->contact['phone'] = !empty($og_phone) ? $og_phone[0]['value'] : '';
        $this->contact['email'] = !empty($og_email) ? $og_email[0]['value'] : '';        
    }
}
